# Create the boot-check script
RUN echo '#!/bin/bash' > /usr/local/bin/boot-check.sh
RUN echo 'sleep 180' >> /usr/local/bin/boot-check.sh
RUN echo 'status=$(systemctl is-system-running)' >> /usr/local/bin/boot-check.sh
RUN echo 'failed_units=$(systemctl --failed --no-legend | wc -l)' >> /usr/local/bin/boot-check.sh
RUN echo 'if [[ "$status" == "running" && "$failed_units" -eq 0 ]]; then' >> /usr/local/bin/boot-check.sh
RUN echo '    sudo ostree admin mark-success' >> /usr/local/bin/boot-check.sh
RUN echo 'else' >> /usr/local/bin/boot-check.sh
RUN echo '    echo "OSTree deployment failed."' >> /usr/local/bin/boot-check.sh
RUN echo 'fi' >> /usr/local/bin/boot-check.sh
RUN chmod +x /usr/local/bin/boot-check.sh

# Create the systemd service
RUN echo '[Unit]' > /etc/systemd/system/boot-check.service
RUN echo 'Description=OSTree 3-Minute Boot Check' >> /etc/systemd/system/boot-check.service
RUN echo 'After=graphical.target' >> /etc/systemd/system/boot-check.service

RUN echo '[Service]' >> /etc/systemd/system/boot-check.service
RUN echo 'Type=simple' >> /etc/systemd/system/boot-check.service
RUN echo 'ExecStart=/usr/local/bin/boot-check.sh' >> /etc/systemd/system/boot-check.service
RUN echo 'RemainAfterExit=yes' >> /etc/systemd/system/boot-check.service

RUN echo '[Install]' >> /etc/systemd/system/boot-check.service
RUN echo 'WantedBy=default.target' >> /etc/systemd/system/boot-check.service

# Enable the service
RUN systemctl enable boot-check.service




# force sddm to use Wayland
RUN mkdir -p /usr/lib/sddm/sddm.conf.d && \
    echo -e "[General]\nDisplayServer=wayland\nGreeterEnvironment=QT_WAYLAND_SHELL_INTEGRATION=layer-shell\n\n[Wayland]\nCompositorCommand=kwin_wayland --drm --no-lockscreen --no-global-shortcuts --locale1" > /usr/lib/sddm/sddm.conf.d/10-wayland.conf && \
    systemctl enable sddm





